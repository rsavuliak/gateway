name: Deploy Gateway to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –∞–ª–µ –¥–æ–±—Ä–µ –¥–ª—è –ª–æ–≥—ñ–≤)
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_KEY_CI }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to DigitalOcean Droplet
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            set -e  # –∑—É–ø–∏–Ω–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –ø–æ–º–∏–ª—Ü—ñ

            echo "‚úÖ –ö—Ä–æ–∫ 1: –ö–ª–æ–Ω –∞–±–æ pull"
            if [ ! -d "/gateway/.git" ]; then
              echo "‚û°Ô∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –Ω–µ —ñ—Å–Ω—É—î. –ö–ª–æ–Ω—É—é..."
              git clone https://github.com/rsavuliak/gateway.git /gateway
            else
              echo "üîÑ –û–Ω–æ–≤–ª—é—é –∫–æ–¥"
              cd /gateway
              git pull origin main
            fi

            echo "‚úÖ –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–µ—Ä–µ–∂—É, —è–∫—â–æ —Ç—Ä–µ–±–∞"
            docker network inspect gateway-network >/dev/null 2>&1 || docker network create gateway-network

            echo "‚úÖ –ö—Ä–æ–∫ 3: –ü–æ–±—É–¥–æ–≤–∞ —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
            cd /gateway
            docker stop gateway || true
            docker rm gateway || true

            docker build -t nginx-gateway .
            docker run -d --name gateway -p 80:80 --network gateway-network nginx-gateway

            echo "üöÄ Gateway –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
          EOF